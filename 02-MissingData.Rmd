# Missing Data and Multiple Imputation {#missing-data}

## Missing Data in R and "Direct Approaches" for Handling Missing Data

* In a wide range of datasets, it is very common to encounter missing value.

* In **R**, missing values are stored as `NA`, meaning "Not Available".

---

* For example, look at the `airquality` dataframe available in base **R**
```{r, echo=TRUE}
data(airquality)
head(airquality)
```

* You can see that the **5th observation** for the `Ozone` variable is missing,
and the **5th and 6th observations** for the `Solar.R` variable are missing.

* You can use `is.na` to find which data entries have missing values.
    + If `is.na` returns `TRUE`, the entry is missing.
    + If `is.na` returns `FALSE`, the entry is not missing
    
```{r, echo=TRUE}
head( is.na(airquality) )
```

* Computing the sum of `is.na(airquality)` tells us how many missing values there are in this dataset.
```{r, echo=TRUE}
sum( is.na(airquality) )  ## 44 missing entries in total
dim( airquality )  ## Dataset has a total of 153 x 6 = 918 entries
```

### Complete Case Analysis (Listwise Deletion)

* Suppose we wanted to run a regression with `Ozone` as the response and `Solar.R`,
`Wind`, and `Temp` as the covariates.

* If we do this in **R**, we will get the following result:
```{r, echo=TRUE}
air.lm1 <- lm( Ozone ~ Solar.R + Wind + Temp, data = airquality )
summary( air.lm1 )
```

---

* How is **R** handling all the **missing values** in `airquality`.

* As a default, `lm` conducts a **complete case analysis** (sometimes referred to as listwise deletion).
     + (This is the default unless you changed the default `na.action` setting with `options(...)`)

* A **complete case analysis** for regression will first **delete all rows** from the dataset if 
any of the variables used from that row have a missing value.
    + In this example, a row will be dropped if either the value of `Ozone`, `Solar.R`, `Wind`, or `Temp`
    is missing. 

* After these observations have been deleted, the usual regression is fit to the remaining "complete" dataset. 

---

* To remove **all rows** where there is at least one missing value, you can use
`na.omit`:
```{r, echo=TRUE}
complete.air <- na.omit( airquality )
## Check that there are no missing values
sum( is.na(complete.air) )  # This should be zero
```

* Because our regression model only uses the variables 


---

* Let's now fit a linear regression using the complete dataset `complete.air`
```{r, echo=TRUE}
air.lm2 <- lm( Ozone ~ Solar.R + Wind + Temp, data = complete.air )
```

* The estimated regression coefficients **should be the same** when using 
the "incomplete dataset" `airquality` as when using the "complete dataset" `complete.air`
```{r, echo=TRUE}
## The estimated regression coefficients should be the same
round(air.lm1$coefficients, 3)
round(air.lm2$coefficients, 3)
```

### Other "Direct" Methods

* In general, doing a **complete-case analysis** is **not advisable**.
    + A complete-case analysis should really only be used if you are confident that the data are missing 
      completely at random (MCAR).

---

* A few other direct ways of handling missing data that you may have used or seen used in practice include:
    1. **Mean imputation**. Missing values are replaced by the value of the **mean** of that variable.
    
    2. **Regression imputation**. Missing values are replaced by a regression prediction from 
    the values of the other variables.


---


## Multiple Imputation

### Short Overview of Multiple Imputation

* To summarize, **multiple imputation** consists of the following steps:
     1. Create $K$ different "complete datasets" which contain no missing data.
     
     2. For each of these $K$ complete datasets, compute the estimates of interest. 
     
     3. "Pool" these separate estimates to get a final estimate. 

---

* The nice thing about multiple imputation is that you can always
use your original analysis approach. 

* That is, you can just apply your original analysis method to each of the $K$ complete datasets.

* The complicated part in multiple imputation is generating the $K$ complete datasets in a **"valid"** way.

* Luckily, there are a number of **R** packages that implement different ways of creating
the $K$ **imputed datasets**.

### Multiple imputation with mice

* I will primarily focus on the **mice** package.
    + **mice** stands for **"Multivariate Imputation by Chained Equations"**

* The `mice` function within the **mice** package is the primary function
for performing **multiple imputation**.

* To use `mice`, just use `mice(df)` where `df` is the **name** of the dataframe.
    + (Set `print = FALSE` if you don't want it to print out the number of the iteration).
    + Choose a value of `seed` so that the results are reproducible.
```{r, echo=TRUE, message=FALSE}
library(mice)
imputed.airs <- mice(airquality, print=FALSE, seed=101)
```

---

* The object returned by `mice` will have a component called `imp` which is a list.
    
* Each component of `imp` is a **dataframe** corresponding to a single variable in the original dataframe 
     + This dataframe will contain the imputed values for the **missing values** of that variable.      

* For example, `imputed.airs$imp` will be a **list** with each component of the list being
one of the variables from `airquality`
```{r, echo=TRUE}
names( imputed.airs$imp )
```

---

* The `Ozone` component of `imputed.airs$imp` will be a dataframe with **37 rows** and **5 columns**.
    + This is because the `Ozone` variable had **37 missing values**, and there are **5 multiple imputations** (the default number in **mice**) 

```{r, echo=TRUE}
dim(imputed.airs$imp$Ozone)
## Imputed missing ozone values across the five multiple imputations
head(imputed.airs$imp$Ozone)
```

* The **row names** in `imputed.airs$imp$Ozone` correspond to the index of the observation
in the original `airquality` dataframe.

* For example, the 5th observation of the `Ozone` variable has 6 in the 1st imputation, 8 in
the 2nd imputation, 18 in the 3rd imputation, etc. ....

---

* Similarly, the `Solar.R` component of `imputed.airs$imp` will be a data frame 
   + This is because the `Ozone` variable had **7 missing values**, and there are **5 multiple imputations**.

```{r, echo=TRUE}
dim(imputed.airs$imp$Solar.R)
## Imputed missing ozone values across the five multiple imputations
head(imputed.airs$imp$Solar.R)
```

* For example, the 5th observation of the `Solar.R` variable has 131 in the 1st imputation, 285 in
the 2nd imputation, 274 in the 3rd imputation, etc. ....

#### with() and pool()

* You could use the components of `imputed.airs$imp` to directly fit **5 separate regression** on the multiply imputed datasets and then average the results.

* However, this is much easier if you just use the **with** function from **mice**
```{r, echo=TRUE}
air.multi.imputelm <- with(imputed.airs, lm( Ozone ~ Solar.R + Wind + Temp))
```

* This will produce **5 different sets** of estimates of the regression coefficients:
```{r, echo=TRUE}
summary(air.multi.imputelm)
```

* To get the "pooled estimates and standard errors" from these 5 different sets of regression coefficients
use the **pool** function from **mice**:
```{r, echo=TRUE}
summary( pool(air.multi.imputelm) )
```

* The pooled **"final estimates"** of the regression coefficients are just the **means** of the estimated regression
coefficients from the 5 multiply imputed datasets.

* The pooled **standard error** for the $j^{th}$ regression coefficient is given by
\begin{equation}
\textrm{pooled } SE_{j} = \sqrt{\frac{1}{K}\sum_{k=1}^{K} SE_{jk}}, 
\end{equation}
where $SE_{jk}$ is the standard error for the $j^{th}$ **regression coefficient** from the $k^{th}$ **complete dataset**.

## Different Missing Data Mechanisms

### Missing Completely at Random (MCAR)

### Missing at Random (MAR)

### Missing not at Random (MNAR)





